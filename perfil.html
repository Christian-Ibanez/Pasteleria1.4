<!DOCTYPE html>
<html lang="es">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <title>Perfil - Pasteleria Mil Sabores</title>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" style="font-family: 'Pacifico', cursive;">Pastelería Mil Sabores</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="productos.html">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="carrito.html">Carrito</a></li>
                    <li class="nav-item"><a class="nav-link" href="perfil.html">Perfil</a></li>
                    <li class="nav-item"><a class="nav-link" href="registro.html">Registro</a></li>
                    <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
                    <li class="nav-item"><a class="nav-link" href="blog.html">Blog</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="container my-5">
        <h2 class="text-center" style="font-family: 'Pacifico', cursive;">Mi Perfil</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="profile-card bg-light">
                    <h4>Información Personal</h4>
                <div id="userInfo">
                <p>No hay información de usuario. <a href="registro.html">Regístrate aquí</a></p>
            </div>
            <button class="btn btn-secondary mt-3" id="editProfileBtn" style="display: none;" onclick="toggleEditMode()">Editar Perfil</button>
        </div>

                <div class="profile-card bg-light mt-4" style="display:none;" id="editProfileForm">
                    <h4>Editar Perfil</h4>
                    <form id="profileForm">
                        <div class="mb-3">
                            <label for="profileName" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="profileName" required>
                        </div>
                        <div class="mb-3">
                            <label for="profileEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="profileEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="profilePassword" class="form-label">Nueva Contraseña</label>
                            <input type="password" class="form-control" id="profilePassword" placeholder="Dejar en blanco para no cambiar">
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        <button type="button" class="btn btn-link" onclick="toggleEditMode()">Cancelar</button>
                    </form>
                </div>
                
                <div class="profile-card bg-light mt-4">
                    <h4>Descuentos Activos</h4>
                    <div id="userDiscounts">
                        <p>No tienes descuentos disponibles.</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="profile-card bg-light">
                    <h4>Historial de Pedidos</h4>
                    <div id="orderHistory">
                        <p>No hay pedidos recientes.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <button class="btn btn-outline-danger" id="logoutBtn" style="display: none;" onclick="logout()">Cerrar Sesión</button>
        </div>
    </section>
    
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cerrar sesión</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-box-arrow-right" style="font-size: 3rem; color: #6c757d;"></i>
                    </div>
                    <h4>¿Estás seguro de que quieres cerrar sesión?</h4>
                    <p>Serás redirigido a la página principal.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmLogout()">Sí, cerrar sesión</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="logoutSuccessModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sesión cerrada</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-check-circle" style="font-size: 3rem; color: #28a745;"></i>
                    </div>
                    <h4>¡Sesión cerrada correctamente!</h4>
                    <p>Serás redirigido a la página principal.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary" onclick="redirectToHome()">Ir al inicio</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
        <div id="profileUpdateToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Perfil Actualizado</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Tu información se ha guardado correctamente.
            </div>
        </div>
    </div>
    
    <footer class="text-center py-3 bg-light">
        <p>&copy; 2025 Pastelería Mil Sabores. ¡Celebra la dulzura de la vida!</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script>
    // Función para cargar información del usuario
    function loadUserProfile() {
    const user = JSON.parse(localStorage.getItem('user'));
    const userInfo = document.getElementById('userInfo');
    const userDiscounts = document.getElementById('userDiscounts');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const editProfileForm = document.getElementById('editProfileForm');
    const logoutBtn = document.querySelector('button[onclick="logout()"]');
    
    if (user) {
        // Mostrar información del usuario
        userInfo.innerHTML = `
            <p><strong>Nombre:</strong> ${user.name}</p>
            <p><strong>Email:</strong> ${user.email}</p>
            ${user.birthdate ? `<p><strong>Fecha de nacimiento:</strong> ${new Date(user.birthdate).toLocaleDateString('es-CL')}</p>` : ''}
        `;
        
        // Mostrar botón de editar perfil
        editProfileBtn.style.display = 'block';
        
        // Asegurar que el formulario de edición esté oculto inicialmente
        editProfileForm.style.display = 'none';
        
        // Mostrar botón de cerrar sesión
        if (logoutBtn) logoutBtn.style.display = 'block';
        
        // Mostrar descuentos si existen
        if (user.discounts && user.discounts.length > 0) {
            userDiscounts.innerHTML = '';
            user.discounts.forEach(discount => {
                userDiscounts.innerHTML += `<span class="badge bg-success me-1 mb-1">${discount}</span>`;
            });
        } else {
            userDiscounts.innerHTML = '<p>No tienes descuentos disponibles.</p>';
        }
        
        // Cargar historial de pedidos
        loadOrderHistory();
    } else {
        // No hay usuario logueado
        userInfo.innerHTML = '<p>No hay información de usuario. <a href="registro.html">Regístrate aquí</a> o <a href="login.html">inicia sesión</a></p>';
        userDiscounts.innerHTML = '<p>No tienes descuentos disponibles.</p>';
        
        // Ocultar botón de editar perfil
        editProfileBtn.style.display = 'none';
        
        // Ocultar formulario de edición
        editProfileForm.style.display = 'none';
        
        // Ocultar botón de cerrar sesión
        if (logoutBtn) logoutBtn.style.display = 'none';
        
        // Mostrar mensaje en historial de pedidos
        document.getElementById('orderHistory').innerHTML = '<p>Inicia sesión para ver tu historial de pedidos.</p>';
    }
}
    
    // Función para cargar historial de pedidos
    // Función para cargar historial de pedidos
function loadOrderHistory() {
    const orderHistory = document.getElementById('orderHistory');
    const user = JSON.parse(localStorage.getItem('user'));
    const userOrders = JSON.parse(localStorage.getItem('userOrders')) || {};
    
    const orders = user && user.email ? userOrders[user.email] || [] : [];
    
    if (orders.length > 0) {
        orderHistory.innerHTML = '';
        orders.forEach(order => {
            let orderHTML = `
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Pedido #${order.id}</h5>
                        <p class="mb-0"><strong>Fecha:</strong> ${order.date}</p>
                    </div>
                    <div class="card-body">
                        <h6>Productos:</h6>
            `;
            
            order.items.forEach(item => {
                orderHTML += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <span><strong>${item.name}</strong></span>
                            <span>$${item.price.toLocaleString('es-CL')} CLP</span>
                        </div>
                        ${item.customMessage ? `
                            <div class="mt-1">
                                <small class="text-muted">Mensaje:</small>
                                <p class="mb-0 fst-italic">"${item.customMessage}"</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            orderHTML += `
                        <div class="mt-3 pt-2 border-top">
                            <div class="d-flex justify-content-between">
                                <strong>Total:</strong>
                                <strong>$${order.total.toLocaleString('es-CL')} CLP</strong>
                            </div>
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-success">${order.status}</span>
                        </div>
                    </div>
                </div>
            `;
            
            orderHistory.innerHTML += orderHTML;
        });
    } else {
        orderHistory.innerHTML = '<p class="text-center">No hay pedidos recientes.</p>';
    }
}
    
    // Funciones de logout
    function logout() {
        const logoutModal = new bootstrap.Modal(document.getElementById('logoutModal'));
        logoutModal.show();
    }
    
    function confirmLogout() {
        localStorage.removeItem('user');
        const logoutModal = bootstrap.Modal.getInstance(document.getElementById('logoutModal'));
        logoutModal.hide();
        
        setTimeout(() => {
            const logoutSuccessModal = new bootstrap.Modal(document.getElementById('logoutSuccessModal'));
            logoutSuccessModal.show();
        }, 300);
    }
    
    function redirectToHome() {
        window.location.href = 'index.html';
    }
    
    // Función para editar perfil
    function toggleEditMode() {
    const editForm = document.getElementById('editProfileForm');
    const user = JSON.parse(localStorage.getItem('user'));
    
    // Solo permitir edición si hay usuario logueado
    if (!user) {
        alert('Debes iniciar sesión para editar tu perfil.');
        window.location.href = 'login.html';
        return;
    }
    
    if (editForm.style.display === 'none' || editForm.style.display === '') {
        editForm.style.display = 'block';
        // Llenar el formulario con los datos actuales del usuario
        document.getElementById('profileName').value = user.name || '';
        document.getElementById('profileEmail').value = user.email || '';
        document.getElementById('profilePassword').value = ''; // Limpiar campo de contraseña
    } else {
        editForm.style.display = 'none';
    }
}
    
    // Manejar el formulario de edición de perfil
    document.getElementById('profileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const user = JSON.parse(localStorage.getItem('user'));
        
        if (user) {
            user.name = document.getElementById('profileName').value;
            user.email = document.getElementById('profileEmail').value;
            const newPassword = document.getElementById('profilePassword').value;
            
            if (newPassword) {
                user.password = newPassword;
            }
            
            localStorage.setItem('user', JSON.stringify(user));
            
            // Mostrar toast de confirmación
            const toast = new bootstrap.Toast(document.getElementById('profileUpdateToast'));
            toast.show();
            
            toggleEditMode();
            loadUserProfile();
        }
    });
    
    // Cargar perfil cuando la página esté lista
    document.addEventListener('DOMContentLoaded', loadUserProfile);
</script>
</body>
</html>